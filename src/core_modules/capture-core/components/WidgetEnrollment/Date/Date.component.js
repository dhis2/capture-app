// @flow
import React, { useState, useCallback } from 'react';
import moment from 'moment';
import { DateField } from 'capture-core/components/FormFields/New';
import {
    Button,
    IconCalendar16,
    IconEdit16,
    colors,
    spacersNum,
} from '@dhis2/ui';
import i18n from '@dhis2/d2-i18n';
import { withStyles } from '@material-ui/core';
import { isValidDate, isValidNonFutureDate } from 'capture-core/utils/validation/validators/form';
import { hasValue } from 'capture-core-utils/validators/form';
import { convertDateObjectToDateFormatString } from 'capture-core/utils/converters/date';
import { systemSettingsStore } from '../../../metaDataMemoryStores';
import { convertValue as convertValueClientToView } from '../../../converters/clientToView';
import { convertValue as convertValueFormToClient } from '../../../converters/formToClient';
import { convertValue as convertValueClientToServer } from '../../../converters/clientToServer';
import { dataElementTypes } from '../../../metaData';


type Props = {
    date: string,
    dateLabel: string,
    locale: string,
    editEnabled: boolean,
    displayAutoGeneratedEventWarning: boolean,
    onSave: (string) => void,
    allowFutureDate?: boolean,
    ...CssClasses,
}

const styles = (theme: Theme) => ({
    editButton: {
        display: 'inline-flex',
        alignItems: 'center',
        justifyContent: 'center',
        flexShrink: 0,
        cursor: 'pointer',
        border: 'none',
        borderRadius: '3px',
        background: 'transparent',
        color: colors.grey600,
        padding: 0,
        marginLeft: '2px',
        '&:focus': {
            outline: 'none',
            background: colors.grey200,
            color: colors.grey800,
        },
        '&:hover': {
            background: colors.grey200,
            color: colors.grey800,
        },
    },
    calendar: {
        paddingTop: '6px',
    },
    inputField: {
        maxWidth: '200px',
    },
    buttonStrip: {
        display: 'flex',
        gap: `${spacersNum.dp4}px`,
        margin: `${spacersNum.dp4}px 0`,
    },
    note: {
        fontSize: '12px',
        color: colors.grey700,
    },
    error: {
        ...theme.typography.caption,
        color: theme.palette.error.main,
    },
});

const DateComponentPlain = ({
    date,
    dateLabel,
    locale,
    editEnabled,
    displayAutoGeneratedEventWarning,
    onSave,
    classes,
    allowFutureDate,
}: Props) => {
    const [editMode, setEditMode] = useState(false);
    const [selectedDate, setSelectedDate] = useState();
    const [validation, setValidation] = useState();

    const validateDate = useCallback((dateString, internalComponentError) => {
        if (!hasValue(dateString)) {
            return {
                error: true,
                validationText: 'A value is required',
            };
        }

        const dateValidation = isValidDate(dateString, internalComponentError);
        if (!dateValidation.valid) {
            return {
                error: true,
                validationText: dateValidation.errorMessage || 'Please provide a valid date',
            };
        }

        if (!allowFutureDate) {
            const futureValidation = isValidNonFutureDate(dateString, internalComponentError);
            if (futureValidation !== true) {
                return {
                    error: true,
                    validationText: futureValidation.errorMessage || 'A date in the future is not allowed',
                };
            }
        }
        return {
            error: false,
            validationText: '',
        };
    }, [allowFutureDate]);

    const dateChangeHandler = useCallback((dateString, internalComponentError) => {
        setSelectedDate(dateString);
        setValidation(validateDate(dateString, internalComponentError));
    }, [setSelectedDate, validateDate]);
    const displayDate = String(convertValueClientToView(date, dataElementTypes.DATE));

    const onOpenEdit = () => {
        setSelectedDate(String(convertValueClientToView(date, dataElementTypes.DATE)));
        setEditMode(true);
    };
    const saveHandler = () => {
        if (selectedDate) {
            const newClientDate = convertValueFormToClient(selectedDate, dataElementTypes.DATE);
            const newDate = convertValueClientToServer(newClientDate, dataElementTypes.DATE);
            if (typeof newDate === 'string' && newDate !== date) {
                onSave(newDate);
            }
        }
        setEditMode(false);
    };

    return editMode ? (
        <div data-test="widget-enrollment-date">
            <div className={classes.inputField}>
                <DateField
                    width={200}
                    value={selectedDate}
                    onBlur={dateChangeHandler}
                    label={dateLabel}
                    dense
                    locale={locale}
                    calendarType={systemSettingsStore.get().calendar}
                    dateFormat={systemSettingsStore.get().dateFormat}
                    validation={validation}
                    calendarMax={!allowFutureDate ? convertDateObjectToDateFormatString(moment()) : undefined}
                />
            </div>
            <div className={classes.buttonStrip}>
                <Button
                    primary
                    small
                    onClick={saveHandler}
                    disabled={!!validation?.error}
                >
                    {i18n.t('Save')}
                </Button>
                <Button
                    secondary
                    small
                    onClick={() => { setEditMode(false); setValidation({}); }}
                >
                    {i18n.t('Cancel')}
                </Button>
            </div>
            {displayAutoGeneratedEventWarning && (
                <div className={classes.note}>
                    {i18n.t('Existing dates for auto-generated events will not be updated.')}
                </div>
            )}
        </div>
    ) : (
        <div className={classes.row} data-test="widget-enrollment-date">
            <span data-test="widget-enrollment-icon-calendar">
                <IconCalendar16 color={colors.grey600} />
            </span>
            {dateLabel}{': '}
            {displayDate}
            {editEnabled &&
                <button
                    className={classes.editButton}
                    data-test="widget-enrollment-icon-edit-date"
                    onClick={onOpenEdit}
                >
                    <IconEdit16 />
                </button>
            }
        </div>
    );
};

export const Date = withStyles(styles)(DateComponentPlain);
