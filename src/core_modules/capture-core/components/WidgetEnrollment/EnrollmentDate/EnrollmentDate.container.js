// @flow
import React, { useState, useEffect } from 'react';
import { useDataMutation } from '@dhis2/app-runtime';
import { EnrollmentDateComponent } from './EnrollmentDate.component';
import { convertValue as convertValueServerToClient } from '../../../converters/serverToClient';
import { convertValue as convertValueClientToServer } from '../../../converters/clientToServer';
import { dataElementTypes } from '../../../metaData';
import { processErrorReports } from '../processErrorReports';

type Props = {
    enrollmentDateLabel: string,
    enrollment: any,
    editEnabled: boolean,
    displayAutoGeneratedEventWarning: boolean,
    onUpdateDate?: (enrollmentDate: string) => void,
    onError?: (errorReport: any) => void,
    ...CssClasses,
}

const enrollmentUpdate = {
    resource: 'tracker?async=false&importStrategy=UPDATE',
    type: 'create',
    data: enrollment => ({
        enrollments: [enrollment],
    }),
};

export const EnrollmentDate = ({
    enrollmentDateLabel,
    enrollment,
    editEnabled,
    displayAutoGeneratedEventWarning,
    onUpdateDate,
    onError,
    classes,
}: Props) => {
    const [enrollmentDate, setEnrollmentDate] = useState(String(convertValueServerToClient(enrollment.enrolledAt, dataElementTypes.DATE)));
    const [newEnrollmentDate, setNewEnrollmentDate] = useState(enrollmentDate);

    const [updateMutation] = useDataMutation(enrollmentUpdate, {
        onComplete: () => {
            setEnrollmentDate(newEnrollmentDate);
            onUpdateDate && onUpdateDate(newEnrollmentDate);
        },
        onError: (e) => {
            setNewEnrollmentDate(enrollmentDate);
            onError && onError(processErrorReports(e));
        },
    });

    const saveHandler = (selectedDate: string) => {
        setNewEnrollmentDate(selectedDate);
    };

    useEffect(() => {
        if (newEnrollmentDate !== enrollmentDate) {
            updateMutation({
                ...enrollment,
                enrolledAt: convertValueClientToServer(newEnrollmentDate, dataElementTypes.DATE),
            });
        }
    }, [newEnrollmentDate, enrollmentDate, updateMutation, enrollment]);

    return (<EnrollmentDateComponent
        enrollmentDateLabel={enrollmentDateLabel}
        enrollmentDate={enrollmentDate}
        editEnabled={editEnabled}
        displayAutoGeneratedEventWarning={displayAutoGeneratedEventWarning}
        saveInProgress={enrollmentDate !== newEnrollmentDate}
        onSave={saveHandler}
        classes={classes}
    />);
};
