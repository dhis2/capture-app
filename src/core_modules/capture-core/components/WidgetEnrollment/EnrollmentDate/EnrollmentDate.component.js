// @flow
import React, { useState, useCallback } from 'react';
import moment from 'moment';
import {
    Button,
    CalendarInput,
    IconCalendar16,
    IconEdit16,
    colors,
    spacersNum,
} from '@dhis2/ui';
import i18n from '@dhis2/d2-i18n';
import { withStyles } from '@material-ui/core';
import { parseDate } from 'capture-core-utils/parsers';
import { convertValue as convertValueClientToView } from '../../../converters/clientToView';
import { dataElementTypes } from '../../../metaData';

type Props = {
    enrollmentDateLabel: string,
    enrollmentDate: string,
    editEnabled: boolean,
    displayAutoGeneratedEventWarning: boolean,
    onSave: (string) => void,
    ...CssClasses,
}

const styles = {
    editButton: {
        display: 'inline-flex',
        alignItems: 'center',
        justifyContent: 'center',
        flexShrink: 0,
        cursor: 'pointer',
        border: 'none',
        borderRadius: '3px',
        background: 'transparent',
        color: colors.grey600,
        padding: 0,
        marginLeft: '2px',
        '&:focus': {
            outline: 'none',
            background: colors.grey200,
            color: colors.grey800,
        },
        '&:hover': {
            background: colors.grey200,
            color: colors.grey800,
        },
    },
    calendar: {
        paddingTop: '6px',
    },
    buttonStrip: {
        display: 'flex',
        gap: `${spacersNum.dp4}px`,
        margin: `${spacersNum.dp4}px 0`,
    },
    note: {
        fontSize: '12px',
        color: colors.grey700,
    },
};

const EnrollmentDateComponentPlain = ({
    enrollmentDateLabel,
    enrollmentDate,
    editEnabled,
    displayAutoGeneratedEventWarning,
    onSave,
    classes,
}: Props) => {
    const [editMode, setEditMode] = useState(false);
    const [selectedDate, setSelectedDate] = useState();
    const dateChangeHandler = useCallback(({ calendarDateString }) => {
        setSelectedDate(calendarDateString);
    }, [setSelectedDate]);
    const displayEnrollmentDate = String(convertValueClientToView(enrollmentDate, dataElementTypes.DATE));

    const onOpenEdit = () => {
        // CalendarInput component only supports the YYYY-MM-DD format
        setSelectedDate(moment(enrollmentDate).format('YYYY-MM-DD'));
        setEditMode(true);
    };
    const saveHandler = () => {
        // CalendarInput component only supports the YYYY-MM-DD format
        // $FlowFixMe[incompatible-use]
        const date = selectedDate ? parseDate(selectedDate, 'YYYY-MM-DD').momentDate.toISOString() : enrollmentDate;
        if (date !== enrollmentDate) {
            onSave(date);
        }
        setEditMode(false);
    };

    return editMode ? (
        <div data-test="widget-enrollment-enrollment-date">
            <CalendarInput
                calendar="gregory"
                dense
                className={classes.calendar}
                label={enrollmentDateLabel}
                inputWidth="50%"
                date={selectedDate}
                onDateSelect={dateChangeHandler}
            />
            <div className={classes.buttonStrip}>
                <Button
                    primary
                    small
                    onClick={saveHandler}
                >
                    {i18n.t('Save')}
                </Button>
                <Button
                    secondary
                    small
                    onClick={() => setEditMode(false)}
                >
                    {i18n.t('Cancel')}
                </Button>
            </div>
            {displayAutoGeneratedEventWarning && (
                <div className={classes.note}>
                    {i18n.t('Existing dates for auto-generated events will not be updated.')}
                </div>
            )}
        </div>
    ) : (
        <div className={classes.row} data-test="widget-enrollment-enrollment-date">
            <span data-test="widget-enrollment-icon-calendar">
                <IconCalendar16 color={colors.grey600} />
            </span>
            {enrollmentDateLabel}{': '}
            {displayEnrollmentDate}
            {editEnabled &&
                <button
                    className={classes.editButton}
                    data-test="widget-enrollment-icon-edit-enrollment-date"
                    onClick={onOpenEdit}
                >
                    <IconEdit16 />
                </button>
            }
        </div>
    );
};

export const EnrollmentDateComponent = withStyles(styles)(EnrollmentDateComponentPlain);
